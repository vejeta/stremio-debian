name: Build and Release Debian Packages

on:
  push:
    tags:
      - 'v*'
    branches:
      - main
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'testing'
        type: choice
        options:
          - testing
          - release

permissions:
  contents: write

env:
  DEBIAN_FRONTEND: noninteractive
  DEBEMAIL: "vejeta@gmail.com"
  DEBFULLNAME: "Juan Manuel Méndez Rey"

jobs:
  build-stremio-client:
    name: Build stremio (main/free) - ${{ matrix.distro }}-${{ matrix.arch }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        distro: [testing, trixie, bookworm, sid, noble]
        arch: [amd64, arm64]
        include:
          - distro: testing
            suite: testing
            os_type: debian
          - distro: trixie
            suite: stable
            os_type: debian
          - distro: bookworm
            suite: oldstable
            os_type: debian
          - distro: sid
            suite: unstable
            os_type: debian
          - distro: noble
            suite: lts
            os_type: ubuntu

    steps:
      - name: Checkout repository with submodules
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Build in ${{ matrix.arch }} container
        uses: uraimo/run-on-arch-action@v2
        with:
          arch: ${{ matrix.arch }}
          distro: ${{ matrix.distro }}
          dockerRunArgs: --privileged
          env: |
            DEBIAN_FRONTEND: noninteractive
            DEBEMAIL: vejeta@gmail.com
            DEBFULLNAME: Juan Manuel Méndez Rey
          install: |
            # Update package lists
            apt-get update

            # CRITICAL: Upgrade all packages to latest versions
            # This ensures Qt and other libraries match current distribution state
            # Prevents Qt ABI mismatches like qtdeclarative-abi-5-15-15 vs 5-15-17
            apt-get upgrade -y

            # Install build dependencies
            apt-get install -y \
              git git-buildpackage pristine-tar \
              debhelper-compat cmake \
              qtbase5-dev qt5-qmake qt5-qmake-bin \
              qtdeclarative5-dev qtwebengine5-dev qttools5-dev \
              qml-module-qtwebchannel qml-module-qt-labs-platform \
              qml-module-qtwebengine qml-module-qtquick-dialogs \
              qml-module-qtquick-controls qml-module-qt-labs-settings \
              qml-module-qt-labs-folderlistmodel \
              libmpv-dev libssl-dev nodejs npm pkg-kde-tools \
              devscripts lintian dpkg-dev fakeroot librsvg2-bin
          run: |
            # Configure git for gbp
            git config --global user.email "$DEBEMAIL"
            git config --global user.name "$DEBFULLNAME"
            git config --global --add safe.directory '*'

            # Create upstream tarball
            cd stremio-client

            # Get version from changelog (without debian revision)
            if [ -f debian/changelog ]; then
              VERSION=$(dpkg-parsechangelog -S Version | cut -d- -f1)
              echo "Creating upstream tarball for version: $VERSION"
            else
              echo "Error: debian/changelog not found"
              exit 1
            fi

            # Try pristine-tar with both .tar.xz and .tar.gz formats
            if git rev-parse --verify pristine-tar >/dev/null 2>&1; then
              echo "Attempting to use pristine-tar..."
              if pristine-tar checkout ../stremio_${VERSION}.orig.tar.xz 2>/dev/null; then
                echo "✓ Generated tarball from pristine-tar (tar.xz)"
              elif pristine-tar checkout ../stremio_${VERSION}.orig.tar.gz 2>/dev/null; then
                echo "✓ Generated tarball from pristine-tar (tar.gz)"
              fi
            fi

            # If pristine-tar didn't work, create from upstream tag
            if [ ! -f ../stremio_${VERSION}.orig.tar.xz ] && [ ! -f ../stremio_${VERSION}.orig.tar.gz ]; then
              echo "Generating tarball from upstream tag..."
              UPSTREAM_TAG=$(git tag -l "upstream/*" | grep -E "${VERSION%+*}" | tail -1)

              if [ -n "$UPSTREAM_TAG" ]; then
                echo "Using upstream tag: $UPSTREAM_TAG"
                git archive --format=tar --prefix=stremio-${VERSION%+*}/ $UPSTREAM_TAG | xz > ../stremio_${VERSION}.orig.tar.xz
              else
                echo "No upstream tag found, creating from current source..."
                cd ..
                tar --exclude-vcs --exclude='debian' --exclude='.pc' \
                  -cJf stremio_${VERSION}.orig.tar.xz stremio-client/
                cd stremio-client
              fi
            fi

            # Show what we created
            ls -lh ../stremio_${VERSION}.orig.tar.* || true

            # Build both source and binary packages
            echo "=== Building packages ==="
            QT_DEFAULT_MAJOR_VERSION=5 dpkg-buildpackage -us -uc -sa

            # Run lintian checks
            echo "=== Running lintian checks ==="
            lintian --info --display-info --pedantic ../*.deb || true

            # Smoke test (Ubuntu only)
            if [ "${{ matrix.os_type }}" = "ubuntu" ]; then
              echo "=== Ubuntu Package Smoke Test ==="
              apt install -y ../*.deb || true

              # Test binary exists
              which stremio && echo "✓ stremio binary found" || echo "✗ stremio binary not found"

              # Test version
              stremio --version 2>&1 || true

              # Check dependencies
              echo "=== Checking linked libraries ==="
              ldd /usr/bin/stremio | grep -E "(libQt5|libmpv|libcrypto)" || true

              # Test headless launch (will timeout, that's expected)
              echo "=== Testing headless GUI initialization ==="
              export QT_QPA_PLATFORM=offscreen
              export QTWEBENGINE_DISABLE_SANDBOX=1
              timeout 10s stremio 2>&1 || echo "✓ GUI initialization test completed"
            fi

      - name: Collect build artifacts
        run: |
          mkdir -p artifacts/stremio-client-${{ matrix.distro }}-${{ matrix.arch }}

          # Rename .deb packages to include distribution name
          # Architecture is already in the .deb filename (e.g., _amd64.deb or _arm64.deb)
          for deb in stremio-client/../*.deb; do
            if [ -f "$deb" ]; then
              filename=$(basename "$deb")
              # Insert distro name before .deb extension
              # stremio_4.4.169+dfsg-1_amd64.deb -> stremio_4.4.169+dfsg-1_amd64-trixie.deb
              newname="${filename%.deb}-${{ matrix.distro }}.deb"
              mv "$deb" "artifacts/stremio-client-${{ matrix.distro }}-${{ matrix.arch }}/$newname"
            fi
          done

          # Move other files without renaming
          mv stremio-client/../*.dsc artifacts/stremio-client-${{ matrix.distro }}-${{ matrix.arch }}/ 2>/dev/null || true
          mv stremio-client/../*.tar.* artifacts/stremio-client-${{ matrix.distro }}-${{ matrix.arch }}/ 2>/dev/null || true
          mv stremio-client/../*.buildinfo artifacts/stremio-client-${{ matrix.distro }}-${{ matrix.arch }}/ 2>/dev/null || true
          mv stremio-client/../*.changes artifacts/stremio-client-${{ matrix.distro }}-${{ matrix.arch }}/ 2>/dev/null || true

          ls -lah artifacts/stremio-client-${{ matrix.distro }}-${{ matrix.arch }}/

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: stremio-client-packages-${{ matrix.distro }}-${{ matrix.arch }}
          path: artifacts/stremio-client-${{ matrix.distro }}-${{ matrix.arch }}/*.deb
          retention-days: 30

      - name: Upload all artifacts for release
        uses: actions/upload-artifact@v4
        with:
          name: stremio-client-all-${{ matrix.distro }}-${{ matrix.arch }}
          path: artifacts/stremio-client-${{ matrix.distro }}-${{ matrix.arch }}/*
          retention-days: 30

  build-stremio-server:
    name: Build stremio-server (non-free) - ${{ matrix.distro }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        distro: [testing, trixie, bookworm, sid, noble]
        include:
          - distro: testing
            suite: testing
            os_type: debian
          - distro: trixie
            suite: stable
            os_type: debian
          - distro: bookworm
            suite: oldstable
            os_type: debian
          - distro: sid
            suite: unstable
            os_type: debian
          - distro: noble
            suite: lts
            os_type: ubuntu
    container:
      image: ${{ matrix.os_type }}:${{ matrix.distro }}

    steps:
      - name: Install build dependencies
        run: |
          # Update package lists
          apt-get update

          # CRITICAL: Upgrade all packages to latest versions
          # This ensures consistent environment with stremio-client builds
          apt-get upgrade -y

          # Install build dependencies
          apt-get install -y \
            git git-buildpackage pristine-tar \
            debhelper-compat nodejs npm \
            devscripts lintian dpkg-dev fakeroot

      - name: Checkout repository with submodules
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Configure git for gbp
        run: |
          git config --global user.email "$DEBEMAIL"
          git config --global user.name "$DEBFULLNAME"
          git config --global --add safe.directory '*'

      - name: Build binary package
        working-directory: stremio-server
        run: |
          # Get version from changelog
          if [ -f debian/changelog ]; then
            VERSION=$(dpkg-parsechangelog -S Version)
            echo "VERSION=$VERSION" >> $GITHUB_ENV
            echo "Building stremio-server version: $VERSION"
          else
            echo "Error: debian/changelog not found"
            exit 1
          fi

          # Build binary-only package (no source package needed for simple packages)
          dpkg-buildpackage -b -us -uc

      - name: Run lintian checks
        continue-on-error: true
        run: |
          lintian --info --display-info --pedantic \
            stremio-server/../*.deb || true

      - name: Collect build artifacts
        run: |
          mkdir -p artifacts/stremio-server-${{ matrix.distro }}

          # Rename .deb packages to include distribution name
          for deb in stremio-server/../*.deb; do
            if [ -f "$deb" ]; then
              filename=$(basename "$deb")
              # Insert distro name before .deb extension
              # stremio-server_4.4.169-1_all.deb -> stremio-server_4.4.169-1_all-trixie.deb
              newname="${filename%.deb}-${{ matrix.distro }}.deb"
              mv "$deb" "artifacts/stremio-server-${{ matrix.distro }}/$newname"
            fi
          done

          # Move other files without renaming
          mv stremio-server/../*.dsc artifacts/stremio-server-${{ matrix.distro }}/ 2>/dev/null || true
          mv stremio-server/../*.tar.* artifacts/stremio-server-${{ matrix.distro }}/ 2>/dev/null || true
          mv stremio-server/../*.buildinfo artifacts/stremio-server-${{ matrix.distro }}/ 2>/dev/null || true
          mv stremio-server/../*.changes artifacts/stremio-server-${{ matrix.distro }}/ 2>/dev/null || true

          ls -lah artifacts/stremio-server-${{ matrix.distro }}/

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: stremio-server-packages-${{ matrix.distro }}
          path: artifacts/stremio-server-${{ matrix.distro }}/*.deb
          retention-days: 30

      - name: Upload all artifacts for release
        uses: actions/upload-artifact@v4
        with:
          name: stremio-server-all-${{ matrix.distro }}
          path: artifacts/stremio-server-${{ matrix.distro }}/*
          retention-days: 30

  create-release:
    name: Create GitHub Release
    needs: [build-stremio-client, build-stremio-server]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts

      - name: Display structure of downloaded files
        run: ls -R release-artifacts

      - name: Create release notes
        id: release_notes
        run: |
          # Capture variables before heredoc
          RELEASE_TAG="${GITHUB_REF_NAME}"
          BUILD_DATE="$(date -u +"%Y-%m-%d %H:%M UTC")"
          WORKFLOW_ID="${GITHUB_RUN_ID}"
          COMMIT_SHA="${GITHUB_SHA:0:8}"

          # Use quoted heredoc to prevent command execution
          cat > RELEASE_NOTES.md << 'ENDOFNOTES'
          # Stremio Debian Packages VERSION_PLACEHOLDER

          ## Installation

          ### Quick Install (APT Repository) - Recommended

          **For Debian Testing (rolling) - Use if you have both trixie + testing sources:**
          ```bash
          wget -qO - https://debian.vejeta.com/key.gpg | sudo gpg --dearmor -o /usr/share/keyrings/stremio-debian.gpg
          echo "deb [signed-by=/usr/share/keyrings/stremio-debian.gpg] https://debian.vejeta.com testing main non-free" | sudo tee /etc/apt/sources.list.d/stremio.list
          sudo apt update
          sudo apt install stremio stremio-server
          ```

          **For Debian Trixie (13 - current stable) - Use if you ONLY have trixie sources:**
          ```bash
          wget -qO - https://debian.vejeta.com/key.gpg | sudo gpg --dearmor -o /usr/share/keyrings/stremio-debian.gpg
          echo "deb [signed-by=/usr/share/keyrings/stremio-debian.gpg] https://debian.vejeta.com trixie main non-free" | sudo tee /etc/apt/sources.list.d/stremio.list
          sudo apt update
          sudo apt install stremio stremio-server
          ```

          **For Debian Bookworm (12 - oldstable):**
          ```bash
          wget -qO - https://debian.vejeta.com/key.gpg | sudo gpg --dearmor -o /usr/share/keyrings/stremio-debian.gpg
          echo "deb [signed-by=/usr/share/keyrings/stremio-debian.gpg] https://debian.vejeta.com bookworm main non-free" | sudo tee /etc/apt/sources.list.d/stremio.list
          sudo apt update
          sudo apt install stremio stremio-server
          ```

          **For Debian Sid (unstable) / Kali Rolling:**
          ```bash
          wget -qO - https://debian.vejeta.com/key.gpg | sudo gpg --dearmor -o /usr/share/keyrings/stremio-debian.gpg
          echo "deb [signed-by=/usr/share/keyrings/stremio-debian.gpg] https://debian.vejeta.com sid main non-free" | sudo tee /etc/apt/sources.list.d/stremio.list
          sudo apt update
          sudo apt install stremio stremio-server
          ```

          **For Ubuntu 24.04 LTS (Noble Numbat) - EXPERIMENTAL:**
          ```bash
          wget -qO - https://debian.vejeta.com/key.gpg | sudo gpg --dearmor -o /usr/share/keyrings/stremio-debian.gpg
          echo "deb [signed-by=/usr/share/keyrings/stremio-debian.gpg] https://debian.vejeta.com noble main non-free" | sudo tee /etc/apt/sources.list.d/stremio.list
          sudo apt update
          sudo apt install stremio stremio-server
          ```

          ### Manual Install (.deb files)

          Download the appropriate .deb files for your distribution below and install with:
          ```bash
          sudo apt install ./stremio_*.deb ./stremio-server_*.deb
          ```

          ## Distributions Supported

          This release includes packages built for:
          - **Debian Testing** - Rolling distribution (use if you have both trixie + testing sources)
          - **Debian Trixie (13)** - Current stable (use if you only have trixie sources)
          - **Debian Bookworm (12)** - Previous stable
          - **Debian Sid** - Unstable (compatible with Kali Rolling)
          - **Ubuntu 24.04 LTS (Noble)** - EXPERIMENTAL (community testing)

          ## Package Details

          - **stremio** (main/free): Desktop client with local playback and HTTP streaming
          - **stremio-server** (non-free): BitTorrent streaming server for enhanced functionality

          ## Changes

          See individual package changelogs in the source repositories:
          - https://salsa.debian.org/mendezr/stremio
          - https://salsa.debian.org/mendezr/stremio-server

          ## Build Information

          - Built on: DATE_PLACEHOLDER
          - Workflow: WORKFLOW_PLACEHOLDER
          - Commit: COMMIT_PLACEHOLDER
          - ITP: Bug #943703
          ENDOFNOTES

          # Replace placeholders with actual values
          sed -i "s/VERSION_PLACEHOLDER/$RELEASE_TAG/g" RELEASE_NOTES.md
          sed -i "s/DATE_PLACEHOLDER/$BUILD_DATE/g" RELEASE_NOTES.md
          sed -i "s/WORKFLOW_PLACEHOLDER/$WORKFLOW_ID/g" RELEASE_NOTES.md
          sed -i "s/COMMIT_PLACEHOLDER/$COMMIT_SHA/g" RELEASE_NOTES.md

          cat RELEASE_NOTES.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ github.ref_name }}
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: false
          files: |
            release-artifacts/stremio-client-packages-*/*.deb
            release-artifacts/stremio-server-packages-*/*.deb
            release-artifacts/stremio-client-all-trixie/*.dsc
            release-artifacts/stremio-client-all-trixie/*.tar.*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Trigger repository update
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          event-type: packages-updated
          client-payload: '{"version": "${{ github.ref_name }}"}'
