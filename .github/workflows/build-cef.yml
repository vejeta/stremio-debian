name: Build CEF Packages

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'CEF version to build (e.g., 144.0.6)'
        required: true
        type: string
      force_rebuild:
        description: 'Force rebuild even if packages exist'
        required: false
        default: false
        type: boolean

permissions:
  contents: write

env:
  DEBIAN_FRONTEND: noninteractive
  DEBEMAIL: "vejeta@gmail.com"
  DEBFULLNAME: "Juan Manuel Mendez Rey"

jobs:
  build-cef:
    name: Build CEF - sid amd64
    # CRITICAL: Must run on self-hosted runner with appropriate resources
    # Required labels: self-hosted, linux, x64, cef-builder
    runs-on: [self-hosted, linux, x64, cef-builder]
    timeout-minutes: 1440  # 24 hours max

    steps:
      - name: Verify runner capabilities
        run: |
          echo "=== Runner Verification ==="
          echo "Hostname: $(hostname)"
          echo "CPU cores: $(nproc)"
          echo "RAM: $(free -h | grep Mem | awk '{print $2}')"
          echo "Disk space: $(df -h / | tail -1 | awk '{print $4}')"

          # Verify minimum requirements
          CORES=$(nproc)
          RAM_GB=$(free -g | grep Mem | awk '{print $2}')
          DISK_GB=$(df -BG / | tail -1 | awk '{print $4}' | tr -d 'G')

          if [ "$CORES" -lt 4 ]; then
            echo "ERROR: Need at least 4 CPU cores (have $CORES)"
            exit 1
          fi

          if [ "$RAM_GB" -lt 8 ]; then
            echo "ERROR: Need at least 8GB RAM (have ${RAM_GB}GB)"
            exit 1
          fi

          if [ "$DISK_GB" -lt 40 ]; then
            echo "ERROR: Need at least 40GB disk (have ${DISK_GB}GB)"
            exit 1
          fi

          echo "Runner meets requirements"

      - name: Checkout repository with submodules
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Verify CEF submodule
        run: |
          if [ ! -d "chromium-embedded-framework/debian" ]; then
            echo "ERROR: chromium-embedded-framework submodule not properly checked out"
            exit 1
          fi
          echo "CEF submodule verified"
          ls -la chromium-embedded-framework/

      - name: Configure git
        run: |
          git config --global user.email "$DEBEMAIL"
          git config --global user.name "$DEBFULLNAME"
          git config --global --add safe.directory '*'

      - name: Clean up old tarballs and build artifacts
        run: |
          # Self-hosted runners persist workspace, so clean up any cached tarballs
          # to ensure we use fresh ones with correct structure
          echo "=== Cleaning up old artifacts ==="
          rm -f chromium-embedded-framework_*.orig*.tar.xz
          rm -f chromium_*.tar.xz
          rm -rf chromium-embedded-framework-*/
          rm -rf depot-tools cef-tmp
          echo "=== Cleanup complete ==="

      - name: Obtain MUT tarballs
        run: |
          # Use the get-orig-tarballs.sh script to create properly named MUT tarballs
          # See debian/README.source for details on MUT format
          # Tarballs use upstream version from changelog (without debian revision)
          # The workflow input version is used only for the release tag
          UPSTREAM_VERSION=$(dpkg-parsechangelog -l chromium-embedded-framework/debian/changelog -S Version | cut -d'-' -f1)
          CEF_BRANCH="7559"  # Branch for CEF 144.x

          echo "=== Creating MUT tarballs for upstream version $UPSTREAM_VERSION ==="
          echo "=== (Release tag will use: ${{ github.event.inputs.version }}) ==="

          # Run the script from within the package directory
          cd chromium-embedded-framework
          chmod +x debian/scripts/get-orig-tarballs.sh
          ./debian/scripts/get-orig-tarballs.sh "$UPSTREAM_VERSION" "$CEF_BRANCH"
          cd ..

          # Verify tarballs were created
          echo "=== MUT tarballs created ==="
          ls -lh chromium-embedded-framework_*.orig*.tar.xz

      - name: Download Chromium Debian patches
        run: |
          # The MUT tarball contains vanilla Chromium source
          # We need the Debian patches (debian.tar.xz) for Step 5.5 in debian/rules
          CHROMIUM_VERSION=$(grep -oP 'chromium_\K[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+' chromium-embedded-framework/debian/rules | head -1)
          echo "Chromium version: $CHROMIUM_VERSION"

          DEBIAN_POOL="https://deb.debian.org/debian/pool/main/c/chromium"

          echo "=== Downloading Chromium debian tarball ==="
          # Find the latest debian revision (handles suffixes like ~deb13u1)
          DEBIAN_TAR=$(wget -qO- "${DEBIAN_POOL}/" | grep -oP "chromium_${CHROMIUM_VERSION}-[^.]+\.debian\.tar\.xz" | sort -V | tail -1)
          echo "Found debian tarball: $DEBIAN_TAR"
          wget -q --show-progress -O "$DEBIAN_TAR" "${DEBIAN_POOL}/${DEBIAN_TAR}"

          # Keep original filename - debian/rules will find it by pattern
          echo "=== Debian patches tarball ready ==="
          ls -lh chromium_*.debian.tar.xz

      - name: Extract MUT source package
        run: |
          # Manually extract MUT tarballs into proper directory structure:
          #   chromium-embedded-framework-VERSION/
          #   ├── cef/           <- from orig.tar.xz
          #   ├── chromium/      <- from orig-chromium.tar.xz
          #   ├── depot-tools/   <- from orig-depot-tools.tar.xz
          #   └── debian/        <- from submodule

          PKG="chromium-embedded-framework"
          # Use upstream version from changelog (same as get-orig-tarballs.sh)
          VERSION=$(dpkg-parsechangelog -l chromium-embedded-framework/debian/changelog -S Version | cut -d'-' -f1)
          echo "Upstream version from changelog: $VERSION"

          # Create fresh build directory (remove any existing one to avoid contamination)
          # CRITICAL: Self-hosted runners persist workspace - old build directories may
          # contain git repositories from previous git clone approach that interfere with
          # MUT tarball extraction (debian/rules assumes git repo for depot-tools reset)
          BUILD_DIR="${PKG}-${VERSION}"
          echo "==> Removing old build directory if it exists"
          rm -rf "$BUILD_DIR"
          mkdir -p "$BUILD_DIR"

          # Extract main CEF tarball (contains cef/ subdirectory)
          echo "==> Extracting CEF source"
          tar -xf "${PKG}_${VERSION}.orig.tar.xz" --strip-components=1 -C "$BUILD_DIR"

          # Extract Chromium component (extracts as chromium-VERSION/, need to rename)
          echo "==> Extracting Chromium source"
          tar -xf "${PKG}_${VERSION}.orig-chromium.tar.xz" -C "$BUILD_DIR"
          # Rename the extracted directory to chromium/
          CHROMIUM_DIR=$(ls -d ${BUILD_DIR}/chromium-* 2>/dev/null | head -1)
          if [ -n "$CHROMIUM_DIR" ] && [ "$CHROMIUM_DIR" != "${BUILD_DIR}/chromium" ]; then
            mv "$CHROMIUM_DIR" "${BUILD_DIR}/chromium"
          fi

          # Extract depot-tools component
          echo "==> Extracting depot-tools"
          tar -xf "${PKG}_${VERSION}.orig-depot-tools.tar.xz" -C "$BUILD_DIR"

          # Copy debian/ directory from submodule
          echo "==> Copying debian directory"
          cp -a chromium-embedded-framework/debian "$BUILD_DIR/"

          echo "=== Source extracted ==="
          ls -la "$BUILD_DIR/"

      - name: Build CEF packages
        run: |
          PKG="chromium-embedded-framework"
          # Use upstream version from changelog (same as extract step)
          VERSION=$(dpkg-parsechangelog -l chromium-embedded-framework/debian/changelog -S Version | cut -d'-' -f1)

          cd ${PKG}-${VERSION}

          # Get version from changelog
          FULL_VERSION=$(dpkg-parsechangelog -S Version)
          echo "Building CEF version: $FULL_VERSION"

          # Export clang-19 as default
          export CC=clang-19
          export CXX=clang++-19
          export PATH="/usr/lib/llvm-19/bin:$PATH"

          # Set TMPDIR to avoid /tmp space issues
          export TMPDIR="$PWD/tmp"
          mkdir -p "$TMPDIR"

          # Build packages (this takes HOURS)
          # Uses system rust-src (Build-Depends), no bundled rust needed
          dpkg-buildpackage -b -us -uc

          # List built packages
          echo "=== Built packages ==="
          ls -lh ../*.deb

      - name: Run lintian checks
        continue-on-error: true
        run: |
          # Find built .deb files (in parent of build directory)
          lintian --info --display-info --pedantic *.deb || true

      - name: Collect build artifacts
        run: |
          mkdir -p artifacts/cef-sid-amd64

          # Built packages are in the current directory (parent of build dir)
          for deb in *.deb; do
            if [ -f "$deb" ]; then
              filename=$(basename "$deb")
              # Add distro suffix for consistency with other packages
              newname="${filename%.deb}-sid.deb"
              mv "$deb" "artifacts/cef-sid-amd64/$newname"
            fi
          done

          # Move other artifacts
          mv *.buildinfo artifacts/cef-sid-amd64/ 2>/dev/null || true
          mv *.changes artifacts/cef-sid-amd64/ 2>/dev/null || true

          echo "=== Collected artifacts ==="
          ls -lah artifacts/cef-sid-amd64/

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cef-packages-sid-amd64
          path: artifacts/cef-sid-amd64/*.deb
          retention-days: 90

      - name: Upload all artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cef-all-sid-amd64
          path: artifacts/cef-sid-amd64/*
          retention-days: 90

  create-cef-release:
    name: Create CEF Release
    needs: [build-cef]
    runs-on: ubuntu-latest

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts

      - name: Display artifacts
        run: ls -R release-artifacts

      - name: Create release notes
        run: |
          CEF_VERSION="${{ github.event.inputs.version }}"
          BUILD_DATE="$(date -u +"%Y-%m-%d %H:%M UTC")"
          WORKFLOW_ID="${GITHUB_RUN_ID}"

          cat > RELEASE_NOTES.md << 'EOF'
          # Chromium Embedded Framework VERSION_PLACEHOLDER

          ## Packages

          - **libcef144** - CEF runtime library
          - **libcef144-dbgsym** - Debug symbols
          - **libcef-dev** - Development headers
          - **cef-resources** - Required runtime resources (locales, PAK files)

          ## Installation

          These packages are available in the APT repository for Debian sid:

          ```bash
          wget -qO - https://debian.vejeta.com/key.gpg | sudo gpg --dearmor -o /usr/share/keyrings/stremio-debian.gpg
          echo "deb [signed-by=/usr/share/keyrings/stremio-debian.gpg] https://debian.vejeta.com sid main non-free" | sudo tee /etc/apt/sources.list.d/stremio.list
          sudo apt update
          sudo apt install libcef144 cef-resources
          ```

          ## Build Information

          - Built on: DATE_PLACEHOLDER
          - Distribution: Debian sid (unstable)
          - Architecture: amd64 only
          - Build runner: Self-hosted (high-memory)
          - Workflow: WORKFLOW_PLACEHOLDER

          ## Note

          CEF packages are only available for Debian sid due to clang-19 requirements.
          These packages are required by stremio-gtk.

          ## License

          CEF is distributed in the `main` component (BSD-licensed core with some bundled components).
          EOF

          # Replace placeholders
          sed -i "s/VERSION_PLACEHOLDER/$CEF_VERSION/g" RELEASE_NOTES.md
          sed -i "s/DATE_PLACEHOLDER/$BUILD_DATE/g" RELEASE_NOTES.md
          sed -i "s/WORKFLOW_PLACEHOLDER/$WORKFLOW_ID/g" RELEASE_NOTES.md

          cat RELEASE_NOTES.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: cef-${{ github.event.inputs.version }}
          name: CEF ${{ github.event.inputs.version }}
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: false
          files: |
            release-artifacts/cef-packages-*/*.deb
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Trigger repository update
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          event-type: cef-packages-updated
          client-payload: '{"version": "${{ github.event.inputs.version }}"}'
