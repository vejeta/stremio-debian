name: Build stremio-gtk Packages

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'stremio-gtk version to build (e.g., 1.0.0-beta.12)'
        required: true
        type: string
      force_rebuild:
        description: 'Force rebuild even if packages exist'
        required: false
        default: false
        type: boolean

permissions:
  contents: write

env:
  DEBIAN_FRONTEND: noninteractive
  DEBEMAIL: "vejeta@gmail.com"
  DEBFULLNAME: "Juan Manuel Mendez Rey"

jobs:
  build-stremio-gtk:
    name: Build stremio-gtk - sid amd64
    runs-on: ubuntu-latest
    # Only build for sid/amd64 - matches CEF availability
    # CEF packages must be available in the APT repository first

    steps:
      - name: Checkout repository with submodules
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Verify stremio-gtk submodule
        run: |
          if [ ! -d "stremio-gtk/debian" ]; then
            echo "ERROR: stremio-gtk submodule not properly checked out"
            exit 1
          fi
          echo "stremio-gtk submodule verified"
          ls -la stremio-gtk/

      - name: Build in sid container
        run: |
          docker run --rm --platform linux/amd64 --privileged \
            -v "$PWD:/workspace" \
            -w /workspace \
            -e DEBIAN_FRONTEND=noninteractive \
            -e DEBEMAIL="vejeta@gmail.com" \
            -e DEBFULLNAME="Juan Manuel Mendez Rey" \
            debian:sid \
            bash -c '
              set -e

              # Update and upgrade
              apt-get update && apt-get upgrade -y

              # Add stremio-debian repository for CEF packages
              apt-get install -y wget gnupg
              wget -qO - https://debian.vejeta.com/key.gpg | gpg --dearmor -o /usr/share/keyrings/stremio-debian.gpg
              echo "deb [signed-by=/usr/share/keyrings/stremio-debian.gpg] https://debian.vejeta.com sid main non-free" > /etc/apt/sources.list.d/stremio.list
              apt-get update

              # Install build dependencies
              apt-get install -y \
                git git-buildpackage pristine-tar \
                debhelper-compat quilt \
                rustc cargo libssl-dev pkg-config \
                libgtk-3-dev libgtk-4-dev libadwaita-1-dev \
                libwebkitgtk-6.0-dev libmpv-dev libepoxy-dev \
                libcef-dev libcef-common \
                gettext nodejs pkgconf \
                devscripts lintian dpkg-dev fakeroot

              # Configure git
              git config --global user.email "$DEBEMAIL"
              git config --global user.name "$DEBFULLNAME"
              git config --global --add safe.directory "*"

              cd stremio-gtk

              # Sync to latest Salsa (source of truth)
              echo "=== Syncing stremio-gtk to latest Salsa ==="
              git fetch origin
              git checkout origin/master
              echo "Synced to: $(git log -1 --oneline)"

              # Get version from changelog
              VERSION=$(dpkg-parsechangelog -S Version)
              UPSTREAM_VERSION=$(echo "$VERSION" | cut -d- -f1)
              echo "Building stremio-gtk version: $VERSION (upstream: $UPSTREAM_VERSION)"

              # Fetch pristine-tar and upstream branches for orig tarball
              echo "=== Fetching pristine-tar and upstream branches ==="
              git fetch origin pristine-tar:pristine-tar upstream:upstream

              # Extract vendor/ from pristine-tar tarball
              # vendor/ is NOT in git - it is only in the +ds orig tarball
              echo "=== Extracting vendor/ from pristine-tar tarball ==="
              echo "PATH: $PATH"
              which pristine-tar || echo "pristine-tar not in PATH"
              ORIG_TARBALL="../stremio-gtk_${UPSTREAM_VERSION}.orig.tar.gz"
              echo "Extracting: $ORIG_TARBALL"
              /usr/bin/pristine-tar checkout "$ORIG_TARBALL"
              tar -xzf "$ORIG_TARBALL" --strip-components=1 --wildcards "*/vendor"
              echo "Vendor directory extracted: $(ls -d vendor 2>/dev/null && echo OK || echo MISSING)"
              echo "Vendor crates: $(ls vendor 2>/dev/null | wc -l)"

              # Build with gbp (handles orig tarball automatically)
              # --git-ignore-branch needed because submodule is in detached HEAD state
              # -b to build binary only (avoid dpkg-source issues with vendor binaries)
              # Note: debian/rules on Salsa must NOT have dh_quilt_unpatch in override_dh_clean
              gbp buildpackage --git-ignore-branch --git-pristine-tar --git-upstream-branch=upstream -us -uc -b

              # Lintian check
              echo "=== Running lintian checks ==="
              lintian --info --display-info --pedantic ../*.deb || true
            '

      - name: Collect build artifacts
        run: |
          mkdir -p artifacts/stremio-gtk-sid-amd64

          for deb in stremio-gtk/../*.deb; do
            if [ -f "$deb" ]; then
              filename=$(basename "$deb")
              # Add distro suffix
              newname="${filename%.deb}-sid.deb"
              mv "$deb" "artifacts/stremio-gtk-sid-amd64/$newname"
            fi
          done

          # Move other artifacts
          mv stremio-gtk/../*.buildinfo artifacts/stremio-gtk-sid-amd64/ 2>/dev/null || true
          mv stremio-gtk/../*.changes artifacts/stremio-gtk-sid-amd64/ 2>/dev/null || true

          echo "=== Collected artifacts ==="
          ls -lah artifacts/stremio-gtk-sid-amd64/

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: stremio-gtk-packages-sid-amd64
          path: artifacts/stremio-gtk-sid-amd64/*.deb
          retention-days: 90

      - name: Upload all artifacts
        uses: actions/upload-artifact@v4
        with:
          name: stremio-gtk-all-sid-amd64
          path: artifacts/stremio-gtk-sid-amd64/*
          retention-days: 90

  build-stremio-server:
    name: Build stremio-server - sid
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository with submodules
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Build stremio-server in sid container
        run: |
          docker run --rm --platform linux/amd64 --privileged \
            -v "$PWD:/workspace" \
            -w /workspace \
            -e DEBIAN_FRONTEND=noninteractive \
            -e DEBEMAIL="vejeta@gmail.com" \
            -e DEBFULLNAME="Juan Manuel Mendez Rey" \
            debian:sid \
            bash -c '
              set -e

              apt-get update && apt-get upgrade -y
              apt-get install -y \
                git debhelper-compat nodejs npm \
                devscripts lintian dpkg-dev fakeroot

              git config --global user.email "$DEBEMAIL"
              git config --global user.name "$DEBFULLNAME"
              git config --global --add safe.directory "*"

              cd stremio-server

              # Sync to latest Salsa
              echo "=== Syncing stremio-server to latest Salsa ==="
              git fetch origin
              git checkout origin/master
              echo "Synced to: $(git log -1 --oneline)"

              # Get version from changelog
              VERSION=$(dpkg-parsechangelog -S Version)
              echo "Building stremio-server version: $VERSION"

              # Build binary package (simple build without pristine-tar)
              dpkg-buildpackage -b -us -uc

              # Lintian check
              echo "=== Running lintian checks ==="
              lintian --info --display-info --pedantic ../*.deb || true
            '

      - name: Collect stremio-server artifacts
        run: |
          mkdir -p artifacts/stremio-server-sid

          for deb in stremio-server/../stremio-server*.deb; do
            if [ -f "$deb" ]; then
              filename=$(basename "$deb")
              newname="${filename%.deb}-sid.deb"
              mv "$deb" "artifacts/stremio-server-sid/$newname"
            fi
          done

          echo "=== Collected stremio-server artifacts ==="
          ls -lah artifacts/stremio-server-sid/

      - name: Upload stremio-server artifacts
        uses: actions/upload-artifact@v4
        with:
          name: stremio-server-packages-sid
          path: artifacts/stremio-server-sid/*.deb
          retention-days: 90

  create-gtk-release:
    name: Create stremio-gtk Release
    needs: [build-stremio-gtk, build-stremio-server]
    runs-on: ubuntu-latest

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts

      - name: Display artifacts
        run: ls -R release-artifacts

      - name: Create release notes
        run: |
          GTK_VERSION="${{ github.event.inputs.version }}"
          # Sanitize version for GitHub tag (~ and + are not allowed)
          # 1.0.0~beta.12+ds-1 -> 1.0.0-beta.12.ds-1
          GTK_TAG_VERSION=$(echo "$GTK_VERSION" | sed 's/~/-/g; s/+/./g')
          echo "GTK_TAG_VERSION=$GTK_TAG_VERSION" >> $GITHUB_ENV
          echo "Original version: $GTK_VERSION"
          echo "Tag version: $GTK_TAG_VERSION"
          BUILD_DATE="$(date -u +"%Y-%m-%d %H:%M UTC")"
          WORKFLOW_ID="${GITHUB_RUN_ID}"

          cat > RELEASE_NOTES.md << 'EOF'
          # stremio-gtk VERSION_PLACEHOLDER

          ## Packages

          - **stremio-gtk** - GTK4/Adwaita-based Stremio client with CEF web engine
          - **stremio-server** - Stremio streaming server (required)

          ## Installation

          These packages are available in the APT repository for Debian sid:

          ```bash
          wget -qO - https://debian.vejeta.com/key.gpg | sudo gpg --dearmor -o /usr/share/keyrings/stremio-debian.gpg
          echo "deb [signed-by=/usr/share/keyrings/stremio-debian.gpg] https://debian.vejeta.com sid main non-free" | sudo tee /etc/apt/sources.list.d/stremio.list
          sudo apt update
          sudo apt install stremio-gtk stremio-server
          ```

          ## Dependencies

          stremio-gtk requires CEF packages (installed automatically):
          - libcef145
          - libcef-common

          ## Why stremio-gtk?

          - **Qt5 EOL**: The original stremio client uses Qt5/QtWebEngine, but Qt5 has reached End-of-Life
          - **Modern UI**: GTK4/Adwaita interface following GNOME HIG
          - **Wayland Native**: Full Wayland support
          - **Active Development**: Uses CEF (Chromium Embedded Framework) which is actively maintained

          ## Build Information

          - Built on: DATE_PLACEHOLDER
          - Distribution: Debian sid (unstable)
          - Architecture: amd64 only
          - Build runner: GitHub-hosted
          - Workflow: WORKFLOW_PLACEHOLDER

          ## Note

          stremio-gtk is only available for Debian sid due to CEF dependencies (clang-19 requirement).

          ## Source Code

          - [stremio-gtk on Salsa](https://salsa.debian.org/mendezr/stremio-gtk)

          ## License

          stremio-gtk is licensed under GPL-3.0-only and is distributed in the `main` component.
          EOF

          # Replace placeholders
          sed -i "s/VERSION_PLACEHOLDER/$GTK_VERSION/g" RELEASE_NOTES.md
          sed -i "s/DATE_PLACEHOLDER/$BUILD_DATE/g" RELEASE_NOTES.md
          sed -i "s/WORKFLOW_PLACEHOLDER/$WORKFLOW_ID/g" RELEASE_NOTES.md

          cat RELEASE_NOTES.md

      - name: Delete existing release assets if rebuilding
        run: |
          TAG="gtk-${{ env.GTK_TAG_VERSION }}"
          # Delete all assets from existing release so softprops can re-upload
          gh release view "$TAG" --json assets -q '.assets[].name' 2>/dev/null | while read -r asset; do
            echo "Deleting existing asset: $asset"
            gh release delete-asset "$TAG" "$asset" --yes
          done || true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: gtk-${{ env.GTK_TAG_VERSION }}
          name: stremio-gtk ${{ github.event.inputs.version }}
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: false
          files: |
            release-artifacts/stremio-gtk-packages-*/*.deb
            release-artifacts/stremio-server-packages-*/*.deb
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Trigger repository update
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          event-type: gtk-packages-updated
          client-payload: '{"version": "${{ github.event.inputs.version }}"}'
