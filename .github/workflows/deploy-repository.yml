name: Deploy APT Repository to GitHub Pages

on:
  repository_dispatch:
    types: [packages-updated, cef-packages-updated]
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild of entire repository'
        required: false
        default: 'false'
        type: boolean
  push:
    branches:
      - main
    paths:
      - 'repository-scripts/**'

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-repository:
    name: Build APT Repository
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install repository tools
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg-dev gnupg tree

      - name: Download latest release packages
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Create directory structure for each distribution
          mkdir -p packages/{testing,trixie,bookworm,sid,noble}/{main,non-free}

          # Download latest release assets
          gh release list --limit 1 --json tagName,name | jq -r '.[0].tagName' > latest_tag.txt
          LATEST_TAG=$(cat latest_tag.txt)

          if [ -n "$LATEST_TAG" ]; then
            echo "Downloading packages from release: $LATEST_TAG"

            # Download all .deb packages from the latest release
            mkdir -p temp-downloads
            gh release download "$LATEST_TAG" --pattern "*.deb" --dir temp-downloads/

            # Organize packages by distribution and component
            # Package naming format: stremio_4.4.169+dfsg-1_amd64-trixie.deb
            echo "=== Organizing packages by distribution ==="

            for deb in temp-downloads/*.deb; do
              if [ ! -f "$deb" ]; then continue; fi

              filename=$(basename "$deb")
              echo "Processing: $filename"

              # Extract distribution from filename (last part before .deb)
              # stremio_4.4.169+dfsg-1_amd64-trixie.deb -> trixie
              if [[ "$filename" =~ -([a-z]+)\.deb$ ]]; then
                distro="${BASH_REMATCH[1]}"
                echo "  Detected distribution: $distro"

                # Remove distro suffix from filename for APT repository
                # stremio_4.4.169+dfsg-1_amd64-trixie.deb -> stremio_4.4.169+dfsg-1_amd64.deb
                clean_filename="${filename%-${distro}.deb}.deb"

                # Determine component (main or non-free)
                # non-free: stremio-server, libcef*, cef-resources
                # main: stremio, stremio-gtk
                if [[ "$filename" =~ ^stremio-server ]] || \
                   [[ "$filename" =~ ^libcef ]] || \
                   [[ "$filename" =~ ^cef-resources ]]; then
                  component="non-free"
                else
                  component="main"
                fi

                echo "  Component: $component"
                echo "  Clean filename: $clean_filename"

                # Copy to appropriate directory with clean filename
                cp "$deb" "packages/$distro/$component/$clean_filename"
              else
                echo "  Warning: Could not extract distribution from filename"
              fi
            done

            echo ""
            echo "=== Organized packages ==="
            for distro in testing trixie bookworm sid noble; do
              echo "Distribution: $distro"
              echo "  main:"
              ls -lh packages/$distro/main/ 2>/dev/null || echo "    (empty)"
              echo "  non-free:"
              ls -lh packages/$distro/non-free/ 2>/dev/null || echo "    (empty)"
            done
          else
            echo "No releases found, creating empty repository structure"
          fi

      - name: Download CEF packages from separate releases
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Find latest CEF release (tag format: cef-X.X.X)
          CEF_TAG=$(gh release list --limit 20 | grep "^CEF" | head -1 | awk '{print $1}' | sed 's/CEF/cef-/')

          # Alternative: search by tag pattern
          if [ -z "$CEF_TAG" ]; then
            CEF_TAG=$(gh release list --limit 20 --json tagName -q '.[].tagName' | grep "^cef-" | head -1)
          fi

          if [ -n "$CEF_TAG" ]; then
            echo "Downloading CEF packages from release: $CEF_TAG"
            mkdir -p temp-cef-downloads
            gh release download "$CEF_TAG" --pattern "*.deb" --dir temp-cef-downloads/ || true

            # Move CEF packages to sid/non-free (CEF only supports sid)
            for deb in temp-cef-downloads/*.deb; do
              if [ -f "$deb" ]; then
                filename=$(basename "$deb")
                echo "Processing CEF package: $filename"

                # Remove -sid suffix if present to get clean filename
                clean_filename="${filename%-sid.deb}.deb"
                if [ "$clean_filename" = "$filename" ]; then
                  clean_filename="$filename"
                fi

                # CEF packages go to non-free
                cp "$deb" "packages/sid/non-free/$clean_filename"
                echo "  -> packages/sid/non-free/$clean_filename"
              fi
            done

            echo "=== CEF packages added to sid/non-free ==="
            ls -lh packages/sid/non-free/ 2>/dev/null || echo "(empty)"
          else
            echo "No CEF releases found (this is OK if CEF hasn't been built yet)"
          fi

      - name: Import GPG key
        run: |
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import
          gpg --list-secret-keys --keyid-format=long

      - name: Generate APT repositories for all distributions
        run: |
          chmod +x repository-scripts/*.sh

          echo "=== Generating repository for Debian testing (rolling) ==="
          ./repository-scripts/generate-apt-repo.sh packages/testing/main debian-repo testing main amd64
          ./repository-scripts/generate-apt-repo.sh packages/testing/main debian-repo testing main arm64
          ./repository-scripts/generate-apt-repo.sh packages/testing/non-free debian-repo testing non-free amd64
          ./repository-scripts/generate-apt-repo.sh packages/testing/non-free debian-repo testing non-free arm64

          echo "=== Generating repository for Debian 13 (trixie - stable) ==="
          ./repository-scripts/generate-apt-repo.sh packages/trixie/main debian-repo trixie main amd64
          ./repository-scripts/generate-apt-repo.sh packages/trixie/main debian-repo trixie main arm64
          ./repository-scripts/generate-apt-repo.sh packages/trixie/non-free debian-repo trixie non-free amd64
          ./repository-scripts/generate-apt-repo.sh packages/trixie/non-free debian-repo trixie non-free arm64

          echo "=== Generating repository for Debian 12 (bookworm - oldstable) ==="
          ./repository-scripts/generate-apt-repo.sh packages/bookworm/main debian-repo bookworm main amd64
          ./repository-scripts/generate-apt-repo.sh packages/bookworm/main debian-repo bookworm main arm64
          ./repository-scripts/generate-apt-repo.sh packages/bookworm/non-free debian-repo bookworm non-free amd64
          ./repository-scripts/generate-apt-repo.sh packages/bookworm/non-free debian-repo bookworm non-free arm64

          echo "=== Generating repository for Debian sid (unstable) ==="
          ./repository-scripts/generate-apt-repo.sh packages/sid/main debian-repo sid main amd64
          ./repository-scripts/generate-apt-repo.sh packages/sid/main debian-repo sid main arm64
          ./repository-scripts/generate-apt-repo.sh packages/sid/non-free debian-repo sid non-free amd64
          ./repository-scripts/generate-apt-repo.sh packages/sid/non-free debian-repo sid non-free arm64

          echo "=== Generating repository for Ubuntu 24.04 (noble - LTS) - EXPERIMENTAL ==="
          ./repository-scripts/generate-apt-repo.sh packages/noble/main debian-repo noble main amd64
          ./repository-scripts/generate-apt-repo.sh packages/noble/main debian-repo noble main arm64
          ./repository-scripts/generate-apt-repo.sh packages/noble/non-free debian-repo noble non-free amd64
          ./repository-scripts/generate-apt-repo.sh packages/noble/non-free debian-repo noble non-free arm64

      - name: Create empty non-free-firmware components
        run: |
          # Debian 12+ expects non-free-firmware component
          # Create empty Packages files to match Release file declaration
          for distro in testing trixie bookworm sid noble; do
            echo "Creating empty non-free-firmware for $distro"

            # Create for both amd64 and arm64
            for arch in amd64 arm64; do
              mkdir -p debian-repo/dists/$distro/non-free-firmware/binary-$arch

              # Create empty Packages file
              touch debian-repo/dists/$distro/non-free-firmware/binary-$arch/Packages

              # Compress it
              gzip -k -f debian-repo/dists/$distro/non-free-firmware/binary-$arch/Packages
            done
          done

      - name: Update Release files for all distributions
        run: |
          cd debian-repo

          # Function to update Release file for a distribution
          update_release() {
            local SUITE=$1
            echo "=== Updating Release file for $SUITE ==="

            # Debian 12+ uses split non-free components (non-free + non-free-firmware)
            # List both even though we only use non-free, to suppress APT notices
            cat > dists/$SUITE/Release << EOF
          Origin: Stremio Debian Repository
          Label: Stremio
          Suite: $SUITE
          Codename: $SUITE
          Components: main non-free non-free-firmware
          Architectures: amd64 arm64
          Description: Unofficial Debian packages for Stremio media center ($SUITE)
          Date: $(date -R -u)
          EOF

            # Add checksums
            echo "MD5Sum:" >> dists/$SUITE/Release
            find dists/$SUITE -type f ! -name "Release*" | while read file; do
                relative_path="${file#dists/$SUITE/}"
                md5=$(md5sum "$file" | awk '{print $1}')
                size=$(stat -c%s "$file")
                printf " %s %8d %s\n" "$md5" "$size" "$relative_path" >> dists/$SUITE/Release
            done

            echo "SHA1:" >> dists/$SUITE/Release
            find dists/$SUITE -type f ! -name "Release*" | while read file; do
                relative_path="${file#dists/$SUITE/}"
                sha1=$(sha1sum "$file" | awk '{print $1}')
                size=$(stat -c%s "$file")
                printf " %s %8d %s\n" "$sha1" "$size" "$relative_path" >> dists/$SUITE/Release
            done

            echo "SHA256:" >> dists/$SUITE/Release
            find dists/$SUITE -type f ! -name "Release*" | while read file; do
                relative_path="${file#dists/$SUITE/}"
                sha256=$(sha256sum "$file" | awk '{print $1}')
                size=$(stat -c%s "$file")
                printf " %s %8d %s\n" "$sha256" "$size" "$relative_path" >> dists/$SUITE/Release
            done
          }

          # Update all distributions
          update_release testing
          update_release trixie
          update_release bookworm
          update_release sid
          update_release noble

          cd ..

      - name: Sign repositories for all distributions
        run: |
          echo "=== Signing testing repository ==="
          ./repository-scripts/sign-repository.sh debian-repo testing "${{ secrets.GPG_KEY_ID }}"

          echo "=== Signing trixie repository ==="
          ./repository-scripts/sign-repository.sh debian-repo trixie "${{ secrets.GPG_KEY_ID }}"

          echo "=== Signing bookworm repository ==="
          ./repository-scripts/sign-repository.sh debian-repo bookworm "${{ secrets.GPG_KEY_ID }}"

          echo "=== Signing sid repository ==="
          ./repository-scripts/sign-repository.sh debian-repo sid "${{ secrets.GPG_KEY_ID }}"

          echo "=== Signing noble repository ==="
          ./repository-scripts/sign-repository.sh debian-repo noble "${{ secrets.GPG_KEY_ID }}"

      - name: Export GPG public key
        run: |
          gpg --armor --export "${{ secrets.GPG_KEY_ID }}" > debian-repo/key.gpg
          echo "GPG key exported to key.gpg"

      - name: Validate repository structure
        run: |
          echo "=== Running automated repository validation ==="
          chmod +x ./repository-scripts/validate-repository.sh
          ./repository-scripts/validate-repository.sh debian-repo

      - name: Create repository index page
        run: |
          cat > debian-repo/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Stremio Debian Repository</title>
              <style>
                  body {
                      font-family: system-ui, -apple-system, sans-serif;
                      max-width: 800px;
                      margin: 50px auto;
                      padding: 20px;
                      line-height: 1.6;
                  }
                  code {
                      background: #f4f4f4;
                      padding: 2px 6px;
                      border-radius: 3px;
                  }
                  pre {
                      background: #f4f4f4;
                      padding: 15px;
                      border-radius: 5px;
                      overflow-x: auto;
                  }
                  .warning {
                      background: #fff3cd;
                      border-left: 4px solid #ffc107;
                      padding: 15px;
                      margin: 20px 0;
                  }
                  .info {
                      background: #d1ecf1;
                      border-left: 4px solid #0c5460;
                      padding: 15px;
                      margin: 20px 0;
                  }
                  h1 { color: #333; }
                  h2 { color: #555; margin-top: 30px; }
              </style>
          </head>
          <body>
              <h1>üé¨ Stremio Debian Repository</h1>

              <p>Unofficial Debian packages for <strong>Stremio</strong> media center, built from source and following Debian packaging standards. Available for <strong>amd64</strong> and <strong>arm64</strong> (Raspberry Pi) architectures.</p>

              <div class="warning">
                  <strong>‚ö†Ô∏è Unofficial Repository:</strong> These packages are not part of the official Debian archive. Use at your own discretion.
              </div>

              <div class="info">
                  <strong>üì¶ Official Debian Submission Status:</strong><br>
                  This package is currently being submitted to official Debian as
                  <a href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=943703">ITP #943703</a>
                  and is under Debian Developer review. This repository provides early access to
                  official-quality packages while the Debian inclusion process is ongoing.
                  The maintainer (<a href="mailto:vejeta@gmail.com">Juan Manuel M√©ndez Rey</a>)
                  is the same for both this repository and the official Debian submission.
              </div>

              <h2>Quick Installation</h2>

              <h3>1. Add repository GPG key</h3>
              <pre>wget -qO - https://debian.vejeta.com/key.gpg | sudo gpg --dearmor -o /usr/share/keyrings/stremio-debian.gpg</pre>

              <h3>2. Add repository to sources</h3>

              <p><strong>For Debian testing (rolling) - Use if you have both trixie + testing sources:</strong></p>
              <pre>echo "deb [signed-by=/usr/share/keyrings/stremio-debian.gpg] https://debian.vejeta.com testing main non-free" | sudo tee /etc/apt/sources.list.d/stremio.list</pre>

              <p><strong>For Debian 13 (trixie - stable) - Use if you ONLY have trixie sources:</strong></p>
              <pre>echo "deb [signed-by=/usr/share/keyrings/stremio-debian.gpg] https://debian.vejeta.com trixie main non-free" | sudo tee /etc/apt/sources.list.d/stremio.list</pre>

              <p><strong>For Debian 12 (bookworm - oldstable):</strong></p>
              <pre>echo "deb [signed-by=/usr/share/keyrings/stremio-debian.gpg] https://debian.vejeta.com bookworm main non-free" | sudo tee /etc/apt/sources.list.d/stremio.list</pre>

              <p><strong>For Debian sid (unstable) / Kali Rolling:</strong></p>
              <pre>echo "deb [signed-by=/usr/share/keyrings/stremio-debian.gpg] https://debian.vejeta.com sid main non-free" | sudo tee /etc/apt/sources.list.d/stremio.list</pre>

              <p><strong>For Ubuntu 24.04 LTS (Noble Numbat) - EXPERIMENTAL:</strong></p>
              <pre>echo "deb [signed-by=/usr/share/keyrings/stremio-debian.gpg] https://debian.vejeta.com noble main non-free" | sudo tee /etc/apt/sources.list.d/stremio.list</pre>

              <div class="warning">
                  <strong>‚ö†Ô∏è Ubuntu Support is Experimental:</strong> Ubuntu packages are built automatically but have limited testing. Community feedback is welcome via GitHub Issues.
              </div>

              <h3>3. Install Stremio</h3>
              <pre>sudo apt update
          sudo apt install stremio stremio-server</pre>

              <h2>Supported Distributions</h2>
              <ul>
                  <li><strong>Debian testing</strong> - Rolling distribution (use if you have both trixie + testing sources)</li>
                  <li><strong>Debian 13 (trixie)</strong> - Current stable release (use if you only have trixie sources)</li>
                  <li><strong>Debian 12 (bookworm)</strong> - Previous stable release</li>
                  <li><strong>Debian sid (unstable)</strong> - Rolling release (compatible with Kali Linux)</li>
                  <li><strong>Ubuntu 24.04 LTS (noble)</strong> - EXPERIMENTAL (community testing)</li>
              </ul>

              <h2>Available Packages</h2>

              <ul>
                  <li><strong>stremio</strong> (main/free): Desktop client with Qt5/QML interface (amd64, arm64)</li>
                  <li><strong>stremio-server</strong> (non-free): BitTorrent streaming server (all architectures)</li>
              </ul>

              <h2>Supported Architectures</h2>

              <ul>
                  <li><strong>amd64</strong> - Standard x86_64 desktop/laptop computers</li>
                  <li><strong>arm64</strong> - Raspberry Pi 3/4/5 (64-bit) and other ARM64 devices</li>
              </ul>

              <h2>Manual Download</h2>

              <p>Download .deb files directly from <a href="https://github.com/vejeta/stremio-debian/releases">GitHub Releases</a></p>

              <h2>Source Code</h2>

              <ul>
                  <li><a href="https://salsa.debian.org/mendezr/stremio">stremio (main)</a> - Salsa GitLab</li>
                  <li><a href="https://salsa.debian.org/mendezr/stremio-server">stremio-server (non-free)</a> - Salsa GitLab</li>
                  <li><a href="https://github.com/vejeta/stremio-debian">Build system</a> - GitHub</li>
              </ul>

              <h2>Support</h2>

              <p>Report issues at <a href="https://github.com/vejeta/stremio-debian/issues">GitHub Issues</a></p>

              <hr>

              <p><small>Built with ‚ù§Ô∏è using GitHub Actions ‚Ä¢ Hosted on GitHub Pages ‚Ä¢ Updated: BUILD_DATE</small></p>
          </body>
          </html>
          EOF

          # Update build date
          sed -i "s/BUILD_DATE/$(date -u +"%Y-%m-%d %H:%M UTC")/" debian-repo/index.html

      - name: Display repository structure
        run: |
          echo "=== Repository Structure ==="
          tree -L 4 debian-repo || find debian-repo -type f | sort

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: debian-repo

  deploy:
    name: Deploy to GitHub Pages
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build-repository

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Deployment summary
        run: |
          echo "‚úÖ Repository deployed successfully!"
          echo "URL: ${{ steps.deployment.outputs.page_url }}"
          echo ""
          echo "Custom domain: https://debian.vejeta.com"
          echo ""
          echo "=== Supported Distributions ==="
          echo "üì¶ Debian testing - rolling (use if you have both trixie + testing sources)"
          echo "üì¶ Debian 13 (trixie) - current stable (use if you only have trixie sources)"
          echo "üì¶ Debian 12 (bookworm) - previous stable"
          echo "üì¶ Debian sid (unstable) - rolling release (Kali compatible)"
          echo "üì¶ Ubuntu 24.04 LTS (noble) - EXPERIMENTAL"
          echo ""
          echo "Users can add the repository with:"
          echo ""
          echo "For testing:"
          echo "  wget -qO - https://debian.vejeta.com/key.gpg | sudo gpg --dearmor -o /usr/share/keyrings/stremio-debian.gpg"
          echo "  echo \"deb [signed-by=/usr/share/keyrings/stremio-debian.gpg] https://debian.vejeta.com testing main non-free\" | sudo tee /etc/apt/sources.list.d/stremio.list"
          echo ""
          echo "For trixie:"
          echo "  echo \"deb [signed-by=/usr/share/keyrings/stremio-debian.gpg] https://debian.vejeta.com trixie main non-free\" | sudo tee /etc/apt/sources.list.d/stremio.list"
          echo ""
          echo "For bookworm:"
          echo "  echo \"deb [signed-by=/usr/share/keyrings/stremio-debian.gpg] https://debian.vejeta.com bookworm main non-free\" | sudo tee /etc/apt/sources.list.d/stremio.list"
          echo ""
          echo "For sid/Kali:"
          echo "  echo \"deb [signed-by=/usr/share/keyrings/stremio-debian.gpg] https://debian.vejeta.com sid main non-free\" | sudo tee /etc/apt/sources.list.d/stremio.list"
          echo ""
          echo "For Ubuntu 24.04 LTS (noble) - EXPERIMENTAL:"
          echo "  echo \"deb [signed-by=/usr/share/keyrings/stremio-debian.gpg] https://debian.vejeta.com noble main non-free\" | sudo tee /etc/apt/sources.list.d/stremio.list"
